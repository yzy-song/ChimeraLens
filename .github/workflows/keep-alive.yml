name: Keep Render Backend Alive

on:
  schedule:
    - cron: "*/10 * * * *" # æ¯ 10 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Check current time and maybe ping
        run: |
          START_HOUR=${{ secrets.START_HOUR }}
          END_HOUR=${{ secrets.END_HOUR }}
          PING_URLS=${{ secrets.PING_URLS }}
          MAX_DELAY=${{ secrets.MAX_DELAY }}

          # é»˜è®¤æœ€å¤§å»¶è¿Ÿ 60 ç§’
          if [ -z "$MAX_DELAY" ]; then
            MAX_DELAY=60
          fi

          # å½“å‰å°æ—¶ (0-23)
          CURRENT_HOUR=$(date +"%H")

          echo "â° Current hour: $CURRENT_HOUR"
          echo "ğŸ•— Active window: $START_HOUR - $END_HOUR"

          # åˆ¤æ–­æ˜¯å¦åœ¨æ´»è·ƒæ—¶æ®µ
          if [ "$CURRENT_HOUR" -ge "$START_HOUR" ] && [ "$CURRENT_HOUR" -lt "$END_HOUR" ]; then
            echo "âœ… Within active hours, proceeding..."

            # éšæœºå»¶è¿Ÿ (0 ~ MAX_DELAY ç§’)
            DELAY=$((RANDOM % MAX_DELAY))
            echo "â³ Sleeping for $DELAY seconds before request..."
            sleep $DELAY

            # å¾ªç¯è¯·æ±‚å¤šä¸ª URL
            for url in $PING_URLS; do
              echo "ğŸŒ Pinging $url ..."
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$STATUS" -eq 200 ]; then
                echo "âœ… $url is UP (HTTP $STATUS)"
              else
                echo "âš ï¸ $url returned HTTP $STATUS"
              fi
            done
          else
            echo "â¹ Outside active hours, skipping ping."
          fi
