// packages/db/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// --- 新增 Role 枚举 ---
enum Role {
  USER
  ADMIN
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  password  String?  // <-- 添加密码字段
  avatarUrl String?
  role      Role     @default(USER) // <-- 添加角色字段

  isGuest   Boolean  @default(true)
  guestId   String?  @unique
  credits   Int      @default(10)

  createdIp   String?
  fingerprint String? // 新增设备指纹字段

  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  generations Generation[]
  orders      Order[]
  @@index([fingerprint]) // 为指纹添加索引以加快查询
}

model Order {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount           Int      // 支付金额 (以分为单位，例如 500 表示 5.00)
  credits          Int      // 购买的点数
  currency         String   @default("eur")
  stripeCheckoutId String   @unique
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

model Generation {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompt           String?

  // 我们把模型信息也存起来，便于未来分析
  modelId          String?
  modelProvider    String   @default("replicate")

  templateImageUrl String
  sourceImageUrl   String
  resultImageUrl   String
  createdAt        DateTime @default(now())

  @@index([userId])
}